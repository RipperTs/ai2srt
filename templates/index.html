<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiAI 三步翻译与音视频转录</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<style>
		.accordion-button::after{
			position:absolute;
			left:0;
			margin-left:0;
		}
	</style>
</head>
<body>
    <div class=" px-5  mx-5  shadow">
                <h1 class="text-center py-3">GeminiAI 音视频转录& 三步翻译字幕</h1>
				<div class="accordion accordion-flush" id="accordionExample">
				  <div class="accordion-item">
					<h2 class="accordion-header">
					  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
						修改提示词
					  </button>
					</h2>
					<div id="collapseOne" class="accordion-collapse collapse " data-bs-parent="#accordionExample">
					  <div class="accordion-body">
						<div class="row">							
							<div class="col-4">
								<h3 class="fs-6 text-muted">用于上传字幕时翻译到目标语言的三步反思提示词</h3>
								<textarea  style="min-height:200px" id="prompt_trans"  onchange="update_prompt(this,'prompt_trans')" class="form-control" row="10">{{prompt_trans}}</textarea>
							</div>
							<div class="col-4">
								<h3 class="fs-6 text-muted">用于上传音视频文件进行转录但不翻译的提示词</h3>
								<textarea  style="min-height:200px"  onchange="update_prompt(this,'prompt_recogn')" row="10"  id="prompt_recogn" class="form-control">{{prompt_recogn}}</textarea>
							
							</div>
							<div class="col-4">
								<h3 class="fs-6 text-muted">用于提示转录结果需要翻译的提示词</h3>
								<textarea  style="min-height:200px"  onchange="update_prompt(this,'prompt_recogn_trans')" row="10" id="prompt_recogn_trans" class="form-control">{{prompt_recogn_trans}}</textarea>
							</div>							
						</div>						
					  </div>
					</div>
				  </div>
				</div>
                <form id="translate-form">
                    <div class="row mt-4">
                        <div class="col-md-2">
                            <label for="subtitle-language" class="form-label text-muted">翻译到的目标语言</label>
                            <select class="form-select" id="subtitle-language">
                                <option value="-">选择目标语言</option>
                                <option value="简体中文">简体中文</option>
                                <option value="英语">英语</option>
                                <option value="日语">日语</option>
                                <option value="韩语">韩语</option>
                                <option value="法语">法语</option>
                                <option value="德语">德语</option>
                                <option value="葡萄牙语">葡萄牙语</option>
                                <option value="西班牙语">西班牙语</option>
                                <option value="泰国语">泰国语</option>
                                <option value="越南语">越南语</option>
                                <option value="阿拉伯语">阿拉伯语</option>
                                <option value="荷兰语">荷兰语</option>
                                <option value="俄语">俄语</option>
                                <option value="匈牙利语">匈牙利语</option>
                                <option value="波兰语">波兰语</option>
                                <option value="捷克语">捷克语</option>
                                <option value="瑞典语">瑞典语</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="model" class="form-label text-muted">模型</label>
                            <select class="form-select" id="model">
                                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                                <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="api-key" class="form-label text-muted">Gemini Key</label>
                            <input type="text" class="form-control" id="api-key">
                        </div>
						<div class="col-md-2">
                            <label for="api-key" class="form-label text-muted">代理</label>
                            <input type="text" class="form-control" id="proxy">
                        </div>
						<div class="col-md-2">
                            <label for="api-key" class="form-label text-muted">同时翻译行</label>
                            <input type="text" class="form-control" value="50" id="piliang">
                        </div>
						<div class="col-md-2">
                            <label for="api-key" class="form-label text-muted">翻译后暂停秒</label>
                            <input type="text" class="form-control" value="10" id="waitsec">
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
							<div class="d-flex align-items-center justify-content-between">
                                <button class="btn btn-light text-nowrap"  type="button" id="load-srt">上传原SRT字幕翻译</button>
								<div  id="upload_label_wrap" class=" position-relative d-flex justify-content-end ">
								  <label id="upload_label" for="upload" class=" position-absolute btn btn-light  w-75 end-0  ">上传音视频转录为字幕</label>
								  <input onchange="uploadFile(this)" class="form-control opacity-0 position-relative w-50"  style="z-index:-1"  accept="audio/*,video/*" type="file" id="upload">
								</div>
							</div>
							<div class="input-group ">
                                <textarea placeholder="SRT字幕和音视频只可二选一，选择音视频将转录为字幕，如果同时选择了目标语言，会将转录结果翻译后返回" class="form-control w-100" id="source-srt" rows="10"></textarea>
                            </div>
							
                        </div>
                        <div class="col-md-6 text-end">
								<button class="btn btn-light" type="button" id="download-srt">下载翻译结果为SRT字幕文件</button>
								
                                <textarea placeholder="在此显示翻译后的结果" class="form-control w-100" id="target-srt" rows="10"></textarea>
                        </div>
                    </div>
					<div id="result_tips" class="text-primary text-center"></div>
                    <div class="row mt-4">
                        <div class="col-md-12 text-center">
                            <button class="btn btn-danger btn-lg" type="submit" id="submit-button">提交处理</button>
                        </div>
                    </div>
					
                </form>
				
				
				<div class="my-5 w-auto text-center">
					<a href="https://pyvideotrans.com/gemini.html" class="btn btn-link text-muted text-decoration-none" target="_blank">点击查看如何获取 Gemini Key</a>
				</div>
    </div>

    <script>
	
window.audio_file=null;
function uploadFile(e) {
  const file = e.files[0]; // 获取选择的文件

  if (!file) {
    alert('必须选择音视频上传')
    return;
  }
  window.audio_file=null;

  const formData = new FormData();
  formData.append('audio', file); //  'audio'对应Flask后端接收的参数名
  $('#submit-button').text('上传音视频中...').attr('disabled',true);
  $.ajax({
    url: '/upload', // Flask 后端路由
    type: 'POST',
    data: formData,
    processData: false, // 阻止 jQuery 对数据进行处理
    contentType: false, // 阻止 jQuery 设置 Content-Type
    success: function(response) {
		$('#submit-button').text('提交处理').removeAttr('disabled');
	  if(response.code!==0){
	     return alert(response.msg);
	  }	
	  window.audio_file=response.data;
	  $('#upload_label').addClass('text-primary').text('已上传音频文件！');
	  $('#source-srt').val('');
      console.log('File uploaded successfully:', response);
      // 上传成功后的处理，例如显示成功消息
    },
    error: function(xhr, status, error) {
	$('#submit-button').text('提交处理').removeAttr('disabled');
		alert(error);
      console.error('File upload failed:', error);
      // 上传失败后的处理，例如显示错误消息
    }
  });
}

function update_prompt(e,id){
 if(!e.value.trim()){
   return alert('提示词不可为空');
 }
 
 
$.ajax({
	url: '/update_prompt',
	type: 'POST',
	data: {value:e.value,id:id},
	contentType: 'application/x-www-form-urlencoded',
	success: function(response) {
		console.log(response)
	}
})
}
        $(document).ready(function() {
			let proxy=localStorage.getItem('proxy')
			let api_key=localStorage.getItem('api_key')
			if(proxy){
				$('#proxy').val(proxy)
			}
			if(api_key){
				$('#api-key').val(api_key)
			}
            // 文件选择器
            $('#load-srt').on('click', function() {
                $('#source-srt').val(''); // 清空文本框
                var fileInput = $('<input type="file" accept=".srt">');
                fileInput.on('change', function(e) {
                    var file = e.target.files[0];
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        $('#source-srt').val(e.target.result);
                    };
                    reader.readAsText(file);
                });
                fileInput.trigger('click');
            });

            // 下载翻译结果 SRT 文件
            $('#download-srt').on('click', function() {
                var targetSrt = $('#target-srt').val().trim();
				if(!targetSrt){
					return alert('翻译结果为空，无需下载');
				}
                var blob = new Blob([targetSrt], { type: 'text/plain' });
                var url = window.URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'translation.srt');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // 提交表单
            $('#translate-form').on('submit', function(event) {
                event.preventDefault(); // 阻止表单默认提交行为

                var formData = {
                    'language': $('#subtitle-language').val(),
                    'model_name': $('#model').val(),
                    'api_key': $('#api-key').val(),
                    'proxy': $('#proxy').val().trim(),
                    'text': $('#source-srt').val().trim(),
					'piliang':$('#piliang').val(),
					'waitsec':$('#waitsec').val(),
					"audio_file":window.audio_file
                };
				
				if(!formData['text'] && !formData['audio_file']){
					return alert('必须输入srt字幕或上传音视频文件');
				}
				if(!formData['api_key']){
				
					return alert('必须填写Api Key');
				}
				if(formData['proxy'] && formData['proxy'].substr(0,4)!='http'){
				
					return alert('代理必须以http开头');
				}
				
				if(formData['text'] && formData['audio_file']){
					if(!confirm('同时上传了SRT字幕和音视频，将只对SRT字幕进行翻译，不转录音视频，若需转录请删掉原始SRT字幕，是否继续？')){
						
						return;
					}
					formData['audio_file']='';
				}
				if(formData['text'] && formData['language']=='-'){
					return alert('存在原始SRT字幕情况下必须选择目标语言');
				}
				
				formData['proxy'] && localStorage.setItem('proxy',formData['proxy']);
				localStorage.setItem('api_key',formData['api_key']);

                // 禁用提交按钮
				$('#result_tips').text('')
                $('#submit-button').prop('disabled', true);
                $('#submit-button').text((formData['text']?'翻译':'转录')+'中请等待...');
				$('#target-srt').val('');

                $.ajax({
                    url: '/api',
                    type: 'POST',
                    data: JSON.stringify(formData),
                    contentType: 'application/json',
                    success: function(response) {
                        // 启用提交按钮
                        $('#submit-button').prop('disabled', false);
                        $('#submit-button').text('提交处理');

                        if (response.code === 0) {
                            // 填充翻译结果
							
							
                            
							if(formData['text']){
								$('#result_tips').text('当前为字幕翻译结果')
							}else{
								if(response.data.length==2){
									$('#target-srt').val(response.data[1]);
									$('#source-srt').val(response.data[0]);
								}else{
									$('#source-srt').val(response.data[0]);								
								}
								$('#result_tips').text('当前为音视频转录结果'+(formData['audio_file']?`，并翻译为${formData["language"]}`:''))
							}
                        } else {
                            // 显示错误信息
                            alert(response.msg);
                        }
                    },
                    error: function(xhr, status, error) {
                        // 启用提交按钮
                        $('#submit-button').text('提交处理');
                        $('#submit-button').prop('disabled', false);
                        alert('请求错误！' + error);
                    }
                });
            });
        });
    </script>
</body>
</html>